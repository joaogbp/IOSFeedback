name: Swift

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  lint:
    runs-on: macos-latest
    outputs:
      outputLintSuccess: ${{ steps.stepLintSuccess.outputs.result }}
      outputLintFailure: ${{ steps.stepLintFailure.outputs.result }}
    steps:
    - name: Repository checkout
      uses: actions/checkout@v2
    - name: Lint
      run: swiftlint
    - name: 🤔 Lint - Check Results - Success ✅
      if: ${{ success() }} # steps.build.outputs.exit_status == 0
      id: stepLintSuccess
      run: |
        echo "::set-output name=result::✅ Lint"
    - name: 🤔 Lint - Check Results - Failure ❌
      if: ${{ failure() }} # steps.build.outputs.exit_status != 0
      id: stepLintFailure
      run: |
        echo "::set-output name=result::❌ Lint"

  ios:
    runs-on: macos-latest
    outputs:
      outputBuildSuccess: ${{ steps.stepBuildSuccess.outputs.result }}
      outputBuildFailure: ${{ steps.stepBuildFailure.outputs.result }}
      outputTestsSuccess: ${{ steps.stepTestsSuccess.outputs.result }}
      outputTestsFailure: ${{ steps.stepTestsFailure.outputs.result }}
      outputFinalSuccess: ${{ steps.stepFinalSuccess.outputs.result }}
      outputFinalFailure: ${{ steps.stepFinalFailure.outputs.result }}
    env:
      GITHUB_ACCESS_TOKEN: ${{ secrets.TOKEN_CI }}
      GYM_USE_SYSTEM_SCM: true
      SCAN_USE_SYSTEM_SCM: true
    steps:
    - name: Repository checkout
      uses: actions/checkout@v2
    - name: List
      run: ls
      
    - name: Add Private Repo Auth
      run: git config --global --add url."https://${GITHUB_ACCESS_TOKEN}@github.com/${GITHUB_REPOSITORY_OWNER}".insteadOf "https://github.com/${GITHUB_REPOSITORY_OWNER}"
    - name: 📱 Build List
      run: xcodebuild -list
    
    - name: 📱 Build for iOS
      id: build
      run: set -o pipefail && env NSUnbufferedIO=YES xcodebuild build-for-testing -scheme LibraryFeedback -destination "platform=iOS Simulator,OS=latest,name=iPhone 12" | xcpretty
    - name: 🤔 Build for iOS - Check Results - Success ✅
      if: ${{ success() }} # steps.build.outputs.exit_status == 0
      id: stepBuildSuccess
      run: |
        echo "::set-output name=result::✅ Build"
    - name: 🤔 Build for iOS - Check Results - Failure ❌
      if: ${{ failure() }} # steps.build.outputs.exit_status != 0
      id: stepBuildFailure
      run: |
        echo "::set-output name=result::❌ Build"
    
    - name: 📱 Tests for iOS
      id: tests
      run: set -o pipefail && env NSUnbufferedIO=YES xcodebuild test-without-building -scheme LibraryFeedbackTests -destination "platform=iOS Simulator,OS=latest,name=iPhone 12" | xcpretty
    - name: 🧐 Tests for iOS - Check Results - Success ✅
      if: ${{ success() }} # steps.tests.outputs.exit_status == 0
      id: stepTestsSuccess
      run: |
        echo "::set-output name=result::✅ Tests"
    - name: 🧐 Tests for iOS - Check Results - Failure ❌
      if: ${{ failure() }} # steps.tests.outputs.exit_status != 0
      id: stepTestsFailure
      run: |
        echo "::set-output name=result::❌ Tests"
    
    - name: 👋🏻 Done - Check Results - Success ✅
      if: ${{ success() }}
      id: stepFinalSuccess
      run: |
        echo "::set-output name=result::✅"
    - name: 👋🏻 Done - Check Results - Failure ❌
      if: ${{ failure() }}
      id: stepFinalFailure
      run: |
        echo "::set-output name=result::❌"
      
  message:
    if: ${{ always() }}
    needs: [lint, ios]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: whatsapp-notify
        id: whatsapp-notify
        env:
          account_sid: ${{ secrets.twilio_account_sid }}
          auth_token: ${{ secrets.twilio_auth_token }}
          to_whatsapp_no: ${{ secrets.twilio_to_whatsapp_no }}
          message: "CI 👉🏻 [Main] LibraryFeedback ${{needs.ios.outputs.outputFinalSuccess}}${{needs.ios.outputs.outputFinalFailure}}\nSteps:\n - ${{needs.lint.outputs.outputLintSuccess}}${{needs.lint.outputs.outputLintFailure}}\n - ${{needs.ios.outputs.outputBuildSuccess}}${{needs.ios.outputs.outputBuildFailure}}\n - ${{needs.ios.outputs.outputTestsSuccess}}${{needs.ios.outputs.outputTestsFailure}}"
        uses: khaled-ibtikar/whatsapp-push-notify-action@master
